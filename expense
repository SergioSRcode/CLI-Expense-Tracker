#!/usr/bin/env node

const { Client } = require('pg');
const { argv } = require('node:process');

let client = new Client({ database: 'expenses'});

const HELP = `An expense recording system

Commands:

add AMOUNT MEMO [DATE] - record a new expense
clear - delete all expenses
list - list all expenses
delete NUMBER - remove expense with id NUMBER
serach QUERY - list expenses with a matching memo field`;

function displayHelp() {
  console.log(HELP);
}

async function listExpenses() {
  let data = await client.query(`SELECT * FROM expenses ORDER BY created_on`);

  data.rows.forEach(row => {
    let columns = [
      `${row.id}`.padStart(3),
      row.created_on.toDateString().padStart(10),
      row.amount.padStart(12),
      row.memo
    ];

    console.log(columns.join(' | '));
  });
}

async function addExpenses(amount, memo) {
  let date = new Date();
  date = date.toLocaleDateString();

  try {
    await client.query(`
        INSERT INTO expenses (amount, memo, created_on)
          VALUES (${amount}, '${memo}', '${date}')`);
  } catch {
    console.log('You must provide an amount and memo');
  }
}

async function runApp() {
  await client.connect();
  let command = (argv[2] || "").toLowerCase();

  if (command === 'list') {
    await listExpenses();
  } else if (command === 'add') {
    await addExpenses(argv[3], argv[4]);
  } else {
    displayHelp();
  }

  await client.end();
}

runApp();

